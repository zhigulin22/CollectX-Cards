// Wallet Database Schema
// Двойной баланс: USDT (внешняя) + $X (внутренняя)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USERS ============

model User {
  id           String   @id @default(uuid())
  telegramId   BigInt   @unique @map("telegram_id")
  username     String?  @db.VarChar(255)
  firstName    String?  @map("first_name") @db.VarChar(255)
  tonAddress   String?  @map("ton_address") @db.VarChar(100)
  createdAt    DateTime @default(now()) @map("created_at")
  
  // Admin controls
  isBlocked    Boolean  @default(false) @map("is_blocked")
  blockReason  String?  @map("block_reason") @db.VarChar(255)
  adminNotes   String?  @map("admin_notes") @db.Text
  
  wallet            Wallet?
  // FIX: Single relation for all transactions where this user is the related party
  relatedTransactions Transaction[] @relation("RelatedTransactions")
  withdrawRequests  WithdrawRequest[]

  @@map("users")
}

// ============ WALLET ============

model Wallet {
  id           String   @id @default(uuid())
  userId       String   @unique @map("user_id")
  
  // Двойной баланс
  balanceUsdt  Decimal  @default(0) @map("balance_usdt") @db.Decimal(20, 6)
  balanceX     Decimal  @default(0) @map("balance_x") @db.Decimal(20, 2)
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("wallets")
}

// ============ TRANSACTIONS ============

model Transaction {
  id            String   @id @default(uuid())
  walletId      String   @map("wallet_id")
  
  // Тип: deposit, swap, send, receive, withdraw
  type          String   @db.VarChar(20)
  
  // Валюта операции: USDT или X
  currency      String   @db.VarChar(10)
  
  // Сумма (положительная или отрицательная)
  amount        Decimal  @db.Decimal(20, 6)
  
  // Баланс ПОСЛЕ операции
  balanceAfter  Decimal  @map("balance_after") @db.Decimal(20, 6)
  
  // Для swap: комиссия
  fee           Decimal? @db.Decimal(20, 6)
  
  // Для send/receive: связанный пользователь
  relatedUserId String?  @map("related_user_id")
  
  // Описание
  description   String?  @db.VarChar(255)
  
  // External transaction hash (for deposits) - UNIQUE for idempotency
  externalTxHash String? @unique @map("external_tx_hash") @db.VarChar(100)
  
  createdAt     DateTime @default(now()) @map("created_at")

  wallet          Wallet           @relation(fields: [walletId], references: [id], onDelete: Cascade)
  // FIX: relatedUser points to the OTHER party in the transaction
  // - For 'send' type: relatedUserId = receiver
  // - For 'receive' type: relatedUserId = sender  
  relatedUser     User?            @relation("RelatedTransactions", fields: [relatedUserId], references: [id])
  withdrawRequest WithdrawRequest?

  @@index([walletId, createdAt(sort: Desc)])
  @@index([type])
  @@map("transactions")
}

// ============ WITHDRAW REQUESTS ============

enum WithdrawStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model WithdrawRequest {
  id            String         @id @default(uuid())
  userId        String         @map("user_id")
  
  // Сумма и комиссия
  amount        Decimal        @db.Decimal(20, 6)
  fee           Decimal        @db.Decimal(20, 6)
  netAmount     Decimal        @map("net_amount") @db.Decimal(20, 6)
  
  // Адрес получателя
  toAddress     String         @map("to_address") @db.VarChar(100)
  
  // Статус
  status        WithdrawStatus @default(PENDING)
  
  // Хеш транзакции в блокчейне (после отправки)
  txHash        String?        @map("tx_hash") @db.VarChar(100)
  
  // Причина отказа (если failed/cancelled)
  failReason    String?        @map("fail_reason") @db.VarChar(255)
  
  // Связь с транзакцией в кошельке
  transactionId String?        @unique @map("transaction_id")
  
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  processedAt   DateTime?      @map("processed_at")

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction   Transaction?   @relation(fields: [transactionId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("withdraw_requests")
}

// ============ AUDIT LOG ============

model AuditLog {
  id          String   @id @default(uuid())
  
  // Кто выполнил действие (admin API key или система)
  actor       String   @db.VarChar(50)
  
  // Тип действия
  action      String   @db.VarChar(50)
  
  // На кого/что направлено действие
  targetType  String?  @map("target_type") @db.VarChar(50)
  targetId    String?  @map("target_id")
  
  // Детали в JSON
  details     String?  @db.Text
  
  // IP адрес
  ipAddress   String?  @map("ip_address") @db.VarChar(50)
  
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([actor])
  @@index([action])
  @@index([targetId])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

// ============ SETTINGS ============

model Settings {
  key       String   @id @db.VarChar(50)
  value     String   @db.Text
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}


