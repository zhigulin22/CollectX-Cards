// Wallet Database Schema
// –î–≤–æ–π–Ω–æ–π –±–∞–ª–∞–Ω—Å: USDT (–≤–Ω–µ—à–Ω—è—è) + $X (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USERS ============

model User {
  id           String   @id @default(uuid())
  telegramId   BigInt   @unique @map("telegram_id")
  username     String?  @db.VarChar(255)
  firstName    String?  @map("first_name") @db.VarChar(255)
  tonAddress   String?  @map("ton_address") @db.VarChar(100)
  createdAt    DateTime @default(now()) @map("created_at")
  
  // Admin controls
  isBlocked    Boolean  @default(false) @map("is_blocked")
  blockReason  String?  @map("block_reason") @db.VarChar(255)
  adminNotes   String?  @map("admin_notes") @db.Text
  
  wallet            Wallet?
  // FIX: Single relation for all transactions where this user is the related party
  relatedTransactions Transaction[] @relation("RelatedTransactions")
  withdrawRequests  WithdrawRequest[]

  @@map("users")
}

// ============ WALLET ============

model Wallet {
  id           String   @id @default(uuid())
  userId       String   @unique @map("user_id")
  
  // –î–≤–æ–π–Ω–æ–π –±–∞–ª–∞–Ω—Å
  balanceUsdt  Decimal  @default(0) @map("balance_usdt") @db.Decimal(20, 6)
  balanceX     Decimal  @default(0) @map("balance_x") @db.Decimal(20, 2)
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("wallets")
}

// ============ TRANSACTIONS ============

model Transaction {
  id            String   @id @default(uuid())
  walletId      String   @map("wallet_id")
  
  // –¢–∏–ø: deposit, swap, send, receive, withdraw
  type          String   @db.VarChar(20)
  
  // –í–∞–ª—é—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏: USDT –∏–ª–∏ X
  currency      String   @db.VarChar(10)
  
  // –°—É–º–º–∞ (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è)
  amount        Decimal  @db.Decimal(20, 6)
  
  // –ë–∞–ª–∞–Ω—Å –ü–û–°–õ–ï –æ–ø–µ—Ä–∞—Ü–∏–∏
  balanceAfter  Decimal  @map("balance_after") @db.Decimal(20, 6)
  
  // –î–ª—è swap: –∫–æ–º–∏—Å—Å–∏—è
  fee           Decimal? @db.Decimal(20, 6)
  
  // –î–ª—è send/receive: —Å–≤—è–∑–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  relatedUserId String?  @map("related_user_id")
  
  // –û–ø–∏—Å–∞–Ω–∏–µ
  description   String?  @db.VarChar(255)
  
  // External transaction hash (for deposits) - UNIQUE for idempotency
  externalTxHash String? @unique @map("external_tx_hash") @db.VarChar(100)
  
  createdAt     DateTime @default(now()) @map("created_at")

  wallet          Wallet           @relation(fields: [walletId], references: [id], onDelete: Cascade)
  // FIX: relatedUser points to the OTHER party in the transaction
  // - For 'send' type: relatedUserId = receiver
  // - For 'receive' type: relatedUserId = sender  
  relatedUser     User?            @relation("RelatedTransactions", fields: [relatedUserId], references: [id])
  withdrawRequest WithdrawRequest?

  @@index([walletId, createdAt(sort: Desc)])
  @@index([type])
  @@map("transactions")
}

// ============ WITHDRAW REQUESTS ============

enum WithdrawStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model WithdrawRequest {
  id            String         @id @default(uuid())
  userId        String         @map("user_id")
  
  // –°—É–º–º–∞ –∏ –∫–æ–º–∏—Å—Å–∏—è
  amount        Decimal        @db.Decimal(20, 6)
  fee           Decimal        @db.Decimal(20, 6)
  netAmount     Decimal        @map("net_amount") @db.Decimal(20, 6)
  
  // –ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è
  toAddress     String         @map("to_address") @db.VarChar(100)
  
  // –°—Ç–∞—Ç—É—Å
  status        WithdrawStatus @default(PENDING)
  
  // –•–µ—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –±–ª–æ–∫—á–µ–π–Ω–µ (–ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏)
  txHash        String?        @map("tx_hash") @db.VarChar(100)
  
  // –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ (–µ—Å–ª–∏ failed/cancelled)
  failReason    String?        @map("fail_reason") @db.VarChar(255)
  
  // –°–≤—è–∑—å —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π –≤ –∫–æ—à–µ–ª—å–∫–µ
  transactionId String?        @unique @map("transaction_id")
  
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  processedAt   DateTime?      @map("processed_at")

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction   Transaction?   @relation(fields: [transactionId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("withdraw_requests")
}

// ============ AUDIT LOG ============

model AuditLog {
  id          String   @id @default(uuid())
  
  // –ö—Ç–æ –≤—ã–ø–æ–ª–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ (admin API key –∏–ª–∏ —Å–∏—Å—Ç–µ–º–∞)
  actor       String   @db.VarChar(50)
  
  // –¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è
  action      String   @db.VarChar(50)
  
  // –ù–∞ –∫–æ–≥–æ/—á—Ç–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ
  targetType  String?  @map("target_type") @db.VarChar(50)
  targetId    String?  @map("target_id")
  
  // –î–µ—Ç–∞–ª–∏ –≤ JSON
  details     String?  @db.Text
  
  // IP –∞–¥—Ä–µ—Å
  ipAddress   String?  @map("ip_address") @db.VarChar(50)
  
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([actor])
  @@index([action])
  @@index([targetId])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

// ============ SETTINGS ============

model Settings {
  key       String   @id @db.VarChar(50)
  value     String   @db.Text
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

// ============ CARD COLLECTIONS ============

model CardCollection {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(100)
  description String?  @db.Text
  imageUrl    String?  @map("image_url") @db.VarChar(500)
  icon        String   @default("üÉè") @db.VarChar(10)
  isActive    Boolean  @default(true) @map("is_active")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  cardTemplates CardTemplate[]

  @@map("card_collections")
}

// ============ CARD TEMPLATES ============

enum CardRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

model CardTemplate {
  id           String      @id @default(uuid())
  collectionId String      @map("collection_id")
  name         String      @db.VarChar(100)
  description  String?     @db.Text
  imageUrl     String?     @map("image_url") @db.VarChar(500)
  imageThumb   String?     @map("image_thumb") @db.VarChar(500) // Compressed thumbnail
  emoji        String      @default("üÉè") @db.VarChar(10)
  rarity       CardRarity  @default(COMMON)
  
  // Sell prices
  sellPriceUsdt Decimal    @default(0) @map("sell_price_usdt") @db.Decimal(10, 2)
  sellPriceX    Decimal    @default(0) @map("sell_price_x") @db.Decimal(10, 2)
  
  // Drop chances (override default rarity weights)
  dropWeight   Int         @default(100) @map("drop_weight")
  
  isActive     Boolean     @default(true) @map("is_active")
  totalMinted  Int         @default(0) @map("total_minted")
  maxSupply    Int?        @map("max_supply") // null = unlimited
  
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  collection   CardCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  userCards    UserCard[]

  @@index([collectionId])
  @@index([rarity])
  @@map("card_templates")
}

// ============ USER CARDS (Inventory) ============

model UserCard {
  id           String       @id @default(uuid())
  userId       String       @map("user_id")
  templateId   String       @map("template_id")
  serialNumber Int          @map("serial_number")
  mintedAt     DateTime     @default(now()) @map("minted_at")
  
  // For marketplace (future)
  isListed     Boolean      @default(false) @map("is_listed")
  listPrice    Decimal?     @map("list_price") @db.Decimal(10, 2)

  template     CardTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, serialNumber])
  @@index([userId])
  @@index([templateId])
  @@map("user_cards")
}

// ============ CARD PACKS ============

model CardPack {
  id              String   @id @default(uuid())
  name            String   @db.VarChar(100)
  description     String?  @db.Text
  imageUrl        String?  @map("image_url") @db.VarChar(500)
  icon            String   @default("üì¶") @db.VarChar(10)
  
  // Pricing (null = free)
  priceUsdt       Decimal? @map("price_usdt") @db.Decimal(10, 2)
  priceX          Decimal? @map("price_x") @db.Decimal(10, 2)
  
  cardsCount      Int      @default(3) @map("cards_count")
  guaranteedRarity CardRarity? @map("guaranteed_rarity")
  
  // For free packs
  cooldownSeconds Int?     @map("cooldown_seconds")
  
  gradient        String   @default("from-violet-500 to-purple-600") @db.VarChar(100)
  isActive        Boolean  @default(true) @map("is_active")
  sortOrder       Int      @default(0) @map("sort_order")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("card_packs")
}

// ============ PACK OPENING HISTORY ============

model PackOpening {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  packId    String   @map("pack_id")
  cardIds   String[] @map("card_ids") // Array of UserCard IDs
  paidWith  String?  @map("paid_with") @db.VarChar(10) // USDT, X, or null for free
  paidAmount Decimal? @map("paid_amount") @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([packId])
  @@map("pack_openings")
}


